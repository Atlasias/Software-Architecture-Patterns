제 2 장
# 이벤트 기반 아키텍처
이벤트 기반 아키텍처 패턴은 확장성이 높은 애플리케이션을 생성하는 데 사용되는 널리 사용되는 분산형 비 동기식 아키텍처 패턴이다. 또한 적응력이 뛰어나고 작은 응용 프로그램뿐만 아니라 크고 복잡한 응용 프로그램에도 사용할 수 있다. 이벤트 중심 아키텍처는 이벤트를 비동기적으로 수신하고 처리하는 고도로 분리된 단일 목적 이벤트 처리 구성 요소로 구성된다.
이벤트 기반 아키텍처 패턴은 중개자와 브로커의 두 가지 주요 토폴로지로 구성된다.
중개자 토폴로지는 일반적으로 중앙 중개자를 통해 이벤트 내에서 여러 단계를 조정해야하는 경우에 사용되는 반면, 브로커 토폴로지는 중앙 중개자를 사용하지 않고 이벤트를 함께 연결하려는 경우에 사용된다. 아키텍처 특성과 구현 전략이 이 두 토폴로지간에 서로 다르므로 각 토폴로지를 이해하여 특정 상황에 가장 적합한 것을 알아야한다.

## 중개자 토폴로지
중개자 토폴로지는 여러 단계를 가지며 이벤트를 처리하기 위해 일정 레벨의 오케스트레이션(조정)이 필요한 이벤트에 유용하다. 예를 들어, 주식 거래를 하는 단일 이벤트의 경우 먼저 거래를 확인한 다음 다양한 준수 규칙에 따라 해당 주식 거래의 준수 여부를 확인하고, 브로커에게 거래를 할당하고, 수수료를 계산하고, 마지막으로 그 브로커와 거래한다. 이러한 모든 단계는 단계 순서를 결정하고 연속적으로, 병렬적으로 수행 할 수 있는지 결정하기 위해 일정 수준의 오케스트레이션이 필요할 것이다.
중개자 토폴로지 내에는 이벤트 큐, 이벤트 중개자, 이벤트 채널, 이벤트 프로세서의 네 가지 주요 아키텍처 구성 요소가 있다. 이벤트 흐름은 클라이언트가 이벤트를 이벤트 대기열로 전송하는 것으로 시작하며, 이벤트를 이벤트 중재자로 전송하는 데 사용된다. 이벤트 중재자는 프로세스의 각 단계를 실행하기 위해 이벤트 채널에 추가 비동기 이벤트를 전송하여 초기 이벤트를 수신하고 이벤트를 오케스트레이션(조정)한다. 이벤트 채널에서 청취하는 이벤트 프로세서는 이벤트 중개자로부터 이벤트를 수신하고 특정 비즈니스 로직을 실행하여 이벤트를 처리한다. 그림 2-1은 이벤트 중심 아키텍처 패턴의 일반적인 중개자 토폴로지를 보여준다.


## 그림 2-1. 이벤트 중심 아키텍처 중재자 토폴로지
이벤트 중심 아키텍처에는 열댓 개에서 수백 개의 이벤트 큐가 있는 것이 일반적이다. 패턴은 이벤트 큐 구성 요소의 구현을 명시하지 않는다. 메시지 큐, 웹 서비스 엔드 포인트 또는 이들의 조합일 수 있다.
이 패턴에는 초기 이벤트와 처리 이벤트의 두 가지 유형이 있다. 초기 이벤트는 중재자가 수신한 원래 이벤트인 반면, 처리 이벤트는 중재자가 생성하고 이벤트 처리 구성 요소에 의해 수신되는 이벤트이다.
이벤트 중개자 구성 요소는 초기 이벤트에 포함 된 단계를 조정한다. 초기 이벤트의 각 단계마다 이벤트 중개자가 특정 처리 이벤트를 이벤트 채널로 전송 한 후 이벤트 프로세서가 이를 수신하여 처리한다. 이벤트 중개자는 초기 이벤트를 처리하는 데 필요한 비즈니스 로직을 수행하지는 않으며, 실제로는 초기 이벤트를 처리하는 데 필요한 단계를 숙지하는 역할을 한다. //
이벤트 중개자는 이벤트 채널을 사용하여 초기 이벤트의 각 단계와 관련된 특정 처리 이벤트를 이벤트 프로세서에 비동기 적으로 전달한다. 이벤트 채널은 메시지 큐 또는 메시지 토픽이 될 수 있지만, 메시지 토픽은 중개자 토폴로지에서 가장 널리 사용되므로 처리 이벤트가 여러 이벤트 프로세서 (각각 수신 된 처리 이벤트에 따라 다른 태스크를 수행함)에 의해 처리 될 수 있다.
이벤트 프로세서 구성 요소에는 처리 이벤트를 처리하는 데 필요한 응용 프로그램 비즈니스 로직이 있다. 이벤트 프로세서는 응용 프로그램이나 시스템에서 특정 작업을 수행하는 자립적이고 독립적이며 고도로 분리된 아키텍처 구성 요소이다.


이벤트 프로세서 구성 요소의 세분성은 세분화 (예 : 주문에 대한 판매 세 계산)에서 세분화 (예 : 보험 청구 처리)에 이르기까지 다양 할 수 있지만 일반적으로 각 구성 요소는 이벤트 프로세서 구성 요소는 단일 비즈니스 타스크를 수행해야하며 특정 이벤트를 완료하기 위해 다른 이벤트 프로세서에 의존하지 않아야합니다.
이벤트 중개자는 다양한 방법으로 구현 될 수 있습니다. 아키텍트는 이벤트 중개자에 대해 선택한 솔루션이 요구 사항 및 요구 사항과 일치하도록 이러한 각 구현 옵션을 이해해야합니다.
이벤트 중개자의 가장 단순하고 가장 일반적인 구현은 Spring Integration, Apache Camel 또는 Mule ESB와 같은 오픈 소스 통합 허브를 통하는 것입니다. 이러한 오픈 소스 통합 허브의 이벤트 흐름은 일반적으로 Java 코드 또는 DSL (도메인 별 언어)을 통해 구현됩니다. 보다 정교한 중개 및 오케스트레이션을 위해 공개 소스 Apache ODE와 같은 BPEL 엔진과 결합 된 BPEL (비즈니스 프로세스 실행 언어)을 사용할 수 있습니다. BPEL은 초기 이벤트 처리에 필요한 데이터 및 단계를 설명하는 표준 XML 유사 언어입니다. 보다 복잡한 오케스트레이션 (인간 상호 작용이 포함 된 단계 포함)이 필요한 대규모 응용 프로그램의 경우 jBPM과 같은 BPM (Business Process Manager)을 사용하여 이벤트 중개자를 구현할 수 있습니다.
이 토폴로지를 사용하여 이벤트 중심 아키텍처의 성공을 위해서는 사용자의 요구를 이해하고 올바른 이벤트 중개자 구현과 일치시키는 것이 중요합니다. 간단한 라우팅 로직을 수행하기 위해 BPM 솔루션을 구현하는 것과 마찬가지로 오픈 소스 통합 허브를 사용하여 매우 복잡한 비즈니스 프로세스 관리 오케스트레이션을 수행하는 것은 실패의 레시피입니다.
중개자 토폴로지의 작동 방식을 설명하기 위해 보험 회사를 통해 보험에 가입하고 이사하기로 결정했다고 가정하십시오. 이 경우 초기 이벤트는 재배치 이벤트와 같은 것으로 불릴 수 있습니다. 재배치 이벤트 처리와 관련된 단계는 그림 2-2에 표시된대로 이벤트 중개자 내에 포함됩니다. 각각의 초기 이벤트 단계에 대해, 이벤트 중재자는 처리 이벤트 (예를 들어, 주소 변경, 재 계산 따옴표 등)를 생성하고, 그 처리 이벤트를 이벤트 채널로 전송하고 처리 이벤트가 대응하는 이벤트 프로세서에 의해 처리 될 때까지 기다린다 (예를 들어, , 고객 프로세스, 견적 프로세스 등). 이 프로세스는 초기 이벤트의 모든 단계가 처리 될 때까지 계속됩니다. 이벤트 조정자의 재 계산 견적 및 업데이트 클레임 단계에 대한 단일 막대는 이러한 단계를 동시에 실행할 수 있음을 나타냅니다.

## 브로커 토폴로지
브로커 토폴로지는 중앙 이벤트 중개자가 없다는 점에서 중개자 토폴로지와 다릅니다. 오히려 메시지 흐름은 경량 메시지 브로커 (예 : ActiveMQ, HornetQ 등)를 통해 체인과 같은 방식으로 이벤트 프로세서 구성 요소에 분산됩니다. 이 토폴로지는 비교적 간단한 이벤트 처리 플로우가 있고 중앙 이벤트 오케스트레이션이 필요하지 않은 경우에 유용합니다. 브로커 토폴로지 내에는 두 가지 주요 유형의 아키텍처 구성 요소 인 브로커 구성 요소와 이벤트 프로세서 구성 요소가 있습니다. 브로커 구성 요소는 중앙 집중식 또는 연합 될 수 있으며 이벤트 플로우에서 사용되는 모든 이벤트 채널을 포함합니다.
브로커 구성 요소에 포함 된 이벤트 채널은 메시지 큐, 메시지 토픽 또는 둘의 조합 일 수 있습니다.

### 그림 2-2. 중개자 토폴로지 예
이 토폴로지는 그림 2-3에 설명되어 있습니다. 다이어그램에서 볼 수 있듯이 초기 이벤트를 제어하고 조정하는 중앙 이벤트 중개자 구성 요소가 없습니다. 각 이벤트 프로세서 구성 요소는 이벤트를 처리하고 방금 수행 한 작업을 나타내는 새 이벤트를 게시합니다. 예를 들어, 주식 포트폴리오의 균형을 유지하는 이벤트 프로세서는 주식 분할이라는 초기 이벤트를 수신 할 수 있습니다. 초기 이벤트를 기반으로 이벤트 프로세서는 일부 포트폴리오 리 밸런싱을 수행 한 다음 리 밸런스 포트폴리오라는 새 이벤트를 브로커에 공개 한 다음 다른 이벤트 프로세서가이를 가져올 수 있습니다. 이벤트가 이벤트 프로세서에 의해 공개되었지만 다른 이벤트 프로세서에 의해 선택되지 않은 경우가있을 수 있습니다. 이것은 응용 프로그램을 발전 시키거나 향후 기능 및 확장을 제공 할 때 일반적입니다.

### 그림 2-3. 이벤트 중심 아키텍처 브로커 토폴로지
브로커 토폴로지의 작동 방식을 설명하기 위해 중개자 토폴로지 (피보험자가 이동)에서와 동일한 예를 사용합니다.
브로커 토폴로지에서 초기 이벤트를 수신 할 중앙 이벤트 중개자가 없으므로 고객 프로세스 구성 요소는 이벤트를 직접 수신하고 고객 주소를 변경하며 고객의 주소가 변경되었다는 이벤트를 보냅니다 (예 : 주소 변경 이벤트). .
이 예에서는 주소 변경 이벤트에 관심이있는 두 가지 이벤트 프로세서 인 견적 프로세스와 클레임 프로세스가 있습니다.
따옴표 처리기 구성 요소는 주소 변경을 기반으로 새 자동 보험료율을 다시 계산하고 수행 한 작업을 나타내는 이벤트를 시스템의 나머지 부분에 게시합니다 (예 : recalc quote 이벤트). 반면에 클레임 처리 구성 요소는 동일한 변경 주소 이벤트를 수신하지만이 경우 미해결 보험 클레임을 업데이트하고 이벤트를 업데이트 클레임 이벤트로 시스템에 게시합니다. 그런 다음이 새로운 이벤트는 다른 이벤트 프로세서 구성 요소에 의해 선택되며 해당 특정 시작 이벤트에 대해 더 이상 이벤트가 공개되지 않을 때까지 이벤트 체인이 시스템을 통해 계속됩니다.

### 그림 2-4. 브로커 토폴로지 예
그림 2-4에서 볼 수 있듯이 브로커 토폴로지는 비즈니스 기능을 수행하기위한 이벤트 체인에 관한 것입니다. 브로커 토폴로지를 이해하는 가장 좋은 방법은 릴레이 토폴로지로 생각하는 것입니다. 릴레이 경주에서 주자는 배턴을 잡고 일정 거리를두고 달리고, 마지막 주자가 결승선을 통과 할 때까지 다음 주자에게 배턴을 건네줍니다. 릴레이 경주에서, 주자가 배턴을 넘기면 레이스가 끝납니다. 브로커 토폴로지에서도 마찬가지입니다. 일단 이벤트 프로세서가 이벤트를 처리하면 더 이상 해당 특정 이벤트 처리에 관여하지 않습니다.

## 고려 사항
이벤트 중심 아키텍처 패턴은 주로 비동기식 분산 특성으로 인해 구현하기가 비교적 복잡한 패턴입니다.
이 패턴을 구현할 때는 브로커 또는 중개자 장애 발생시 원격 프로세스 가용성, 응답 부족 및 브로커 재 연결 논리와 같은 다양한 분산 아키텍처 문제를 해결해야합니다.
이 아키텍처 패턴을 선택할 때 고려해야 할 사항은 단일 비즈니스 프로세스에 대한 원 자성 트랜잭션이 없다는 것입니다. 이벤트 프로세서 구성 요소는 분리되어 분산되어 있기 때문에 트랜잭션 작업 단위를 유지 관리하기가 매우 어렵습니다. 이러한 이유로이 패턴을 사용하여 응용 프로그램을 디자인 할 때는 어떤 이벤트가 독립적으로 실행될 수 있고 실행할 수 없는지 지속적으로 생각하고 그에 따라 이벤트 프로세서의 세분성을 계획해야합니다. 이벤트 프로세서에서 단일 작업 단위 (UOW)를 분할해야하는 경우, 즉 분할되지 않은 트랜잭션이 필요한 별도의 프로세서를 사용하는 경우 이는 응용 프로그램에 적합한 패턴이 아닐 수 있습니다.
이벤트 중심 아키텍처 패턴의 가장 어려운 측면 중 하나는 이벤트 프로세서 구성 요소 계약의 생성, 유지 관리 및 관리입니다. 각 이벤트에는 일반적으로 이벤트와 관련된 특정 계약이 있습니다 (예 : 데이터 값 및 데이터 형식이 이벤트 프로세서로 전달됨). 이 패턴을 사용하여 표준 데이터 형식 (예 : XML, JSON, Java Object 등)을 정하고 처음부터 계약 버전 관리 정책을 수립하는 것이 매우 중요합니다.


## 패턴 분석
다음 표에는 이벤트 중심 아키텍처 패턴의 공통 아키텍처 특성에 대한 등급 및 분석이 포함되어 있습니다. 각 특성에 대한 등급은 패턴의 일반적인 구현 및 패턴이 일반적으로 알려진 기능에 따른 기능으로서의 특성에 대한 자연적 경향에 기초합니다. 이 패턴이이 보고서의 다른 패턴과 어떻게 관련되어 있는지 비교하려면이 보고서의 끝에있는 부록 A를 참조하십시오.
전반적인 민첩성
등급 : 높음
분석 : 전반적인 민첩성은 끊임없이 변화하는 환경에 빠르게 대응할 수있는 능력입니다. 이벤트 프로세서 구성 요소는 단일 용도이며 다른 이벤트 프로세서 구성 요소와 완전히 분리되어 있으므로 변경 사항은 일반적으로 하나 이상의 이벤트 프로세서와 실패한 브로커로 분리됩니다.
간편한 배포
등급 : 높음
분석 : 전체적으로이 패턴은 이벤트 프로세서 구성 요소의 분리 된 특성으로 인해 배치가 비교적 쉽습니다. 중개자 토폴로지는 중개자 토폴로지보다 배치하기 쉬운 경향이 있습니다. 주로 이벤트 중개자 구성 요소가 이벤트 프로세서에 다소 밀접하게 연결되어 있기 때문입니다. 이벤트 프로세서 구성 요소를 변경하려면 이벤트 중개자도 변경해야하며 둘 다 필요합니다. 주어진 변경에 대해 배포됩니다.
테스트 가능성
등급 : 낮음
분석 : 개별 단위 테스트는 그리 어렵지 않지만 이벤트를 생성하려면 일종의 특수한 테스트 클라이언트 또는 테스트 도구가 필요합니다. 이 패턴의 비동기 특성으로 인해 테스트도 복잡합니다.
공연
등급 : 높음
분석 : 모든 메시징 인프라로 인해 성능이 좋지 않은 이벤트 중심 아키텍처를 구현할 수는 있지만 일반적으로이 패턴은 비동기 기능을 통해 고성능을 달성합니다. 다시 말해, 분리 된 병렬 비동기 작업을 수행하는 기능은 메시지 대기열 및 대기열 제거 비용보다 중요합니다.
확장 성
등급 : 높음
분석 : 확장 성이 높은 독립형 및 분리 된 이벤트 프로세서를 통해이 패턴에서 자연스럽게 달성됩니다. 각 이벤트 프로세서는 개별적으로 확장 할 수있어 세밀한 확장 성을 제공합니다.
개발의 용이성
등급 : 낮음
분석 : 패턴의 비동기 적 특성과 계약 작성 및 응답이없는 이벤트 프로세서 및 실패한 브로커를위한 코드 내의 고급 오류 처리 조건의 필요성으로 인해 개발이 다소 복잡 할 수 있습니다.
